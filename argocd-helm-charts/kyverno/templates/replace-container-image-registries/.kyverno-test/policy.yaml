apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: replace-container-image-registries
  annotations:
    policies.kyverno.io/title: Replace container image registries
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Replaces upstream container image registries, with the given container image proxy cache
      registry.
    kyverno.io/kubernetes-version: "1.27"
    policies.kyverno.io/minversion: 1.11.4
spec:
  mutateExistingOnPolicyUpdate: false
  rules:
    - name: replace-docker.io
      match:
        any:
          - resources:
              kinds:
                - Pod
              operations:
                - CREATE
                - UPDATE
      mutate:
        foreach:
          - list: request.object.spec.initContainers[]
            context:
              - name: imageData
                imageRegistry:
                  reference: "{{ element.image }}"
            preconditions:
              any:
                - key: "{{ imageData.registry }}"
                  operator: Equals
                  value: docker.io
            patchStrategicMerge:
              spec:
                initContainers:
                  - name: "{{ element.name }}"
                    image: harbor.obmondo.com/{{ imageData.resolvedImage }}
          - list: request.object.spec.containers[]
            context:
              - name: imageData
                imageRegistry:
                  reference: "{{ element.image }}"
            preconditions:
              any:
                - key: "{{ imageData.registry }}"
                  operator: Equals
                  value: docker.io
            patchStrategicMerge:
              spec:
                containers:
                  - name: "{{ element.name }}"
                    image: harbor.obmondo.com/{{ imageData.resolvedImage }}
