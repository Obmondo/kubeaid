externalDatabases:
  netbird:
    size: 8Gi
    recover: false
    pass: netbird-pgsql-app
    logicalbackup:
      enabled: true
  coturn:
    size: 4Gi
    recover: false
    pass: coturn-pgsql-app
    logicalbackup:
      enabled: true

netbird:
  fullnameOverride: netbird
  management:
    configmap: |-
      {
        "Stuns": [
          {
            "Proto": "udp",
            "URI": "{{ .STUN_SERVER }}",
            "Username": "",
            "Password": ""
          }
        ],
        "TURNConfig": {
          "TimeBasedCredentials": false,
          "CredentialsTTL": "12h0m0s",
          "Secret": "secret",
          "Turns": [
            {
              "Proto": "udp",
              "URI": "{{ .TURN_SERVER }}",
              "Username": "{{ .TURN_SERVER_USER }}",
              "Password": "{{ .TURN_SERVER_PASSWORD }}"
            }
          ]
        },
        "Relay": {
          "Addresses": ["rels://vpn.example.com:443/relay"],
          "CredentialsTTL": "24h",
          "Secret": "{{ .RELAY_PASSWORD }}"
        },
        "Signal": {
          "Proto": "https",
          "URI": "vpn.example.com:443",
          "Username": "",
          "Password": ""
        },
        "Datadir": "/var/lib/netbird/",
        "DataStoreEncryptionKey": "{{ .DATASTORE_ENCRYPTION_KEY }}",
        "HttpConfig": {
          "LetsEncryptDomain": "",
          "CertFile": "",
          "CertKey": "",
          "AuthAudience": "{{ .IDP_CLIENT_ID }}",
          "AuthIssuer": "https://keycloak.example.com/auth/realms/netbird",
          "AuthUserIDClaim": "",
          "AuthKeysLocation": "https://keycloak.example.com/auth/realms/netbird/protocol/openid-connect/certs",
          "OIDCConfigEndpoint": "https://keycloak.example.com/auth/realms/netbird/.well-known/openid-configuration",
          "IdpSignKeyRefreshEnabled": false
        },
        "IdpManagerConfig": {
          "ManagerType": "keycloak",
          "ClientConfig": {
            "Issuer": "https://keycloak.example.com/auth/realms/netbird/.well-known/openid-configuration",
            "TokenEndpoint": "https://keycloak.example.com/auth/realms/netbird/protocol/openid-connect/token",
            "ClientID": "{{ .IDP_CLIENT_MGMT_ID }}",
            "ClientSecret": "{{ .IDP_CLIENT_MGMT_SECRET }}",
            "GrantType": "client_credentials"
          },
          "ExtraConfig": {
            "Password": "{{ .IDP_SERVICE_ACCOUNT_PASSWORD }}",
            "Username": "{{ .IDP_SERVICE_ACCOUNT_USER }}",
            "AdminEndpoint": "https://keycloak.example.com/auth/admin/realms/netbird"
          },
          "KeycloakClientCredentials": null
        },
        "DeviceAuthorizationFlow": {
          "Provider": "hosted",
          "ProviderConfig": {
            "ClientID": "{{ .IDP_CLIENT_ID }}",
            "ClientSecret": "",
            "Domain": "keycloak.example.com",
            "Audience": "{{ .IDP_CLIENT_ID }}",
            "TokenEndpoint": "https://keycloak.example.com/auth/realms/netbird/protocol/openid-connect/token",
            "DeviceAuthEndpoint": "https://keycloak.example.com/auth/realms/netbird/protocol/openid-connect/auth/device",
            "AuthorizationEndpoint": "",
            "Scope": "openid",
            "UseIDToken": false,
            "RedirectURLs": null
          }
        },
        "PKCEAuthorizationFlow": {
          "ProviderConfig": {
            "ClientID": "{{ .IDP_CLIENT_ID }}",
            "ClientSecret": "",
            "Domain": "keycloak.example.com",
            "Audience": "{{ .IDP_CLIENT_ID }}",
            "TokenEndpoint": "https://keycloak.example.com/auth/realms/netbird/protocol/openid-connect/token",
            "DeviceAuthEndpoint": "",
            "AuthorizationEndpoint": "",
            "Scope": "openid profile email offline_access api",
            "UseIDToken": false,
            "RedirectURLs": null
          }
        },
        "StoreConfig": {
          "Engine": "postgres"
        },
        "ReverseProxy": {
          "TrustedHTTPProxies": null,
          "TrustedHTTPProxiesCount": 0,
          "TrustedPeers": null
        }
      }

    image:
      tag: 0.46.0
    persistentVolume:
      enabled: false
    envFromSecret:
      NETBIRD_STORE_ENGINE_POSTGRES_DSN: netbird/postgresDSN
      STUN_SERVER: netbird/stunServer
      TURN_SERVER: netbird/turnServer
      TURN_SERVER_USER: netbird/turnServerUser
      TURN_SERVER_PASSWORD: netbird/turnServerPassword
      RELAY_PASSWORD: netbird/relayPassword
      IDP_CLIENT_ID: netbird/idpClientID
      IDP_CLIENT_MGMT_ID: netbird/idpClientMgmtID
      IDP_CLIENT_MGMT_SECRET: netbird/idpClientMgmtSecret
      IDP_SERVICE_ACCOUNT_USER: netbird/idpServiceAccountUser
      IDP_SERVICE_ACCOUNT_PASSWORD: netbird/idpServiceAccountPassword
      DATASTORE_ENCRYPTION_KEY: netbird/datastoreEncryptionKey

  signal:
    image:
      tag: 0.46.0

  relay:
    image:
      tag: 0.46.0
    envFromSecret:
      NB_AUTH_SECRET: netbird/relayPassword
    env:
      NB_LOG_LEVEL: info
      NB_LISTEN_ADDRESS: ":33080"
      NB_EXPOSED_ADDRESS: rels://vpn.example.com:443/relay

  dashboard:
    enabled: true
    image:
      tag: v2.9.0
    env:
      # Endpoints
      NETBIRD_MGMT_API_ENDPOINT: https://vpn.example.com:443
      NETBIRD_MGMT_GRPC_API_ENDPOINT: https://vpn.example.com:443
      # OIDC
      AUTH_CLIENT_SECRET:
      AUTH_AUTHORITY: https://keycloak.example.com/auth/realms/netbird
      USE_AUTH0: false
      AUTH_SUPPORTED_SCOPES: openid profile email offline_access api
      AUTH_REDIRECT_URI:
      AUTH_SILENT_REDIRECT_URI:
      NETBIRD_TOKEN_SOURCE: accessToken
      NGINX_SSL_PORT:
      LETSENCRYPT_DOMAIN:
      LETSENCRYPT_EMAIL:
    envFromSecret:
      AUTH_CLIENT_ID: netbird/idpClientID
      AUTH_AUDIENCE: netbird/idpClientID

  extraManifests:
    - apiVersion: traefik.io/v1alpha1
      kind: IngressRoute
      metadata:
        name: netbird-traefik
        labels:
          argocd.argoproj.io/instance: netbird-traefik
      spec:
        entryPoints:
        - websecure
        routes:
        - kind: Rule
          match: Host(`vpn.example.com`) && !PathPrefix(`/api`) && !PathPrefix(`/management`) && !PathPrefix(`/signalexchange`) && !PathPrefix(`/relay`)
          services:
          - name: netbird-dashboard
            namespace: netbird
            passHostHeader: true
            port: 80
        - kind: Rule
          match: Host(`vpn.example.com`) && PathPrefix(`/api`)
          services:
          - name: netbird-management
            namespace: netbird
            passHostHeader: true
            port: 80
        - kind: Rule
          match: Host(`vpn.example.com`) && PathPrefix(`/relay`)
          services:
          - name: netbird-relay
            namespace: netbird
            passHostHeader: true
            port: 33080
        - kind: Rule
          match: Host(`vpn.example.com`) && PathPrefix(`/management`)
          services:
          - name: netbird-management
            namespace: netbird
            passHostHeader: true
            port: 80
            scheme: h2c
        - kind: Rule
          match: Host(`vpn.example.com`) && PathPrefix(`/signalexchange`)
          services:
          - name: netbird-signal
            namespace: netbird
            passHostHeader: true
            port: 80
            scheme: h2c
        tls:
          secretName: vpn.example.com

coturn:
  externalDatabase:
    enabled: true
    type: "postgresql"
    existingSecret: coturn-pgsql-app
    secretKeys:
      username: "username"
      password: "password"
      database: "dbname"
      hostname: "host"

