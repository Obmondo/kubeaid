netbird:
  fullnameOverride: netbird
  management:
    configmap: |-
      {
        "Stuns": [
          {
            "Proto": "udp",
            "URI": "{{ .STUN_SERVER }}",
            "Username": "",
            "Password": ""
          }
        ],
        "TURNConfig": {
          "TimeBasedCredentials": false,
          "CredentialsTTL": "12h0m0s",
          "Secret": "secret",
          "Turns": [
            {
              "Proto": "udp",
              "URI": "{{ .TURN_SERVER }}",
              "Username": "{{ .TURN_SERVER_USER }}",
              "Password": "{{ .TURN_SERVER_PASSWORD }}"
            }
          ]
        },
        "Relay": {
          "Addresses": ["rels://vpn.example.com:443/relay"],
          "CredentialsTTL": "24h",
          "Secret": "{{ .RELAY_PASSWORD }}"
        },
        "Signal": {
          "Proto": "https",
          "URI": "vpn.example.com:443",
          "Username": "",
          "Password": ""
        },
        "Datadir": "/var/lib/netbird/",
        "DataStoreEncryptionKey": "{{ .DATASTORE_ENCRYPTION_KEY }}",
        "HttpConfig": {
          "LetsEncryptDomain": "",
          "CertFile": "",
          "CertKey": "",
          "AuthAudience": "{{ .IDP_CLIENT_ID }}",
          "AuthIssuer": "https://keycloak.example.com/auth/realms/Obmondo",
          "AuthUserIDClaim": "",
          "AuthKeysLocation": "https://keycloak.example.com/auth/realms/Obmondo/protocol/openid-connect/certs",
          "OIDCConfigEndpoint": "https://keycloak.example.com/auth/realms/Obmondo/.well-known/openid-configuration",
          "IdpSignKeyRefreshEnabled": false
        },
        "IdpManagerConfig": {
          "ManagerType": "keycloak",
          "ClientConfig": {
            "Issuer": "https://keycloak.example.com/auth/realms/Obmondo/.well-known/openid-configuration",
            "TokenEndpoint": "https://keycloak.example.com/auth/realms/Obmondo/protocol/openid-connect/token",
            "ClientID": "{{ .IDP_CLIENT_MGMT_ID }}",
            "ClientSecret": "{{ .IDP_CLIENT_MGMT_SECRET }}",
            "GrantType": "client_credentials"
          },
          "ExtraConfig": {
            "Password": "{{ .IDP_SERVICE_ACCOUNT_PASSWORD }}",
            "Username": "{{ .IDP_SERVICE_ACCOUNT_USER }}",
            "AdminEndpoint": "https://keycloak.example.com/auth/admin/realms/Obmondo"
          },
          "KeycloakClientCredentials": null
        },
        "DeviceAuthorizationFlow": {
          "Provider": "hosted",
          "ProviderConfig": {
            "ClientID": "{{ .IDP_CLIENT_ID }}",
            "ClientSecret": "",
            "Domain": "keycloak.example.com",
            "Audience": "{{ .IDP_CLIENT_ID }}",
            "TokenEndpoint": "https://keycloak.example.com/auth/realms/Obmondo/protocol/openid-connect/token",
            "DeviceAuthEndpoint": "https://keycloak.example.com/auth/realms/Obmondo/protocol/openid-connect/auth/device",
            "AuthorizationEndpoint": "",
            "Scope": "openid",
            "UseIDToken": false,
            "RedirectURLs": null
          }
        },
        "PKCEAuthorizationFlow": {
          "ProviderConfig": {
            "ClientID": "{{ .IDP_CLIENT_ID }}",
            "ClientSecret": "",
            "Domain": "keycloak.example.com",
            "Audience": "{{ .IDP_CLIENT_ID }}",
            "TokenEndpoint": "https://keycloak.example.com/auth/realms/Obmondo/protocol/openid-connect/token",
            "DeviceAuthEndpoint": "",
            "AuthorizationEndpoint": "",
            "Scope": "openid profile email offline_access netbird-vpn-api",
            "UseIDToken": false,
            "RedirectURLs": null
          }
        },
        "StoreConfig": {
          "Engine": "postgres"
        },
        "ReverseProxy": {
          "TrustedHTTPProxies": null,
          "TrustedHTTPProxiesCount": 0,
          "TrustedPeers": null
        }
      }

    podCommand:
      args:
        - --port=80
        - --log-file=console
        - --log-level=debug
        - --disable-anonymous-metrics=false
        - --single-account-mode-domain=vpn.example.com
        - --dns-domain=netbird.selfhosted

    ingressGrpc:
      tls:
        - hosts:
            - vpn.example.com
          secretName: vpn.example.com
      hosts:
        - host: vpn.example.com
          paths:
            - path: /management
              pathType: ImplementationSpecific

    ingress:
      tls:
        - hosts:
            - vpn.example.com
          secretName: vpn.example.com
      hosts:
        - host: vpn.example.com
          paths:
            - path: /api
              pathType: ImplementationSpecific

  signal:
    ingress:
      tls:
        - hosts:
            - vpn.example.com
          secretName: vpn.example.com
      hosts:
        - host: vpn.example.com
          paths:
            - path: /signalexchange
              pathType: ImplementationSpecific

  relay:
    env:
      NB_LOG_LEVEL: info
      NB_LISTEN_ADDRESS: ":33080"
      NB_EXPOSED_ADDRESS: rels://vpn.example.com:443/relay
    ingress:
      tls:
        - hosts:
            - vpn.example.com
          secretName: vpn.example.com
      hosts:
        - host: vpn.example.com
          paths:
            - path: /relay
              pathType: ImplementationSpecific

  dashboard:
    enabled: true
    env:
      # Endpoints
      NETBIRD_MGMT_API_ENDPOINT: https://vpn.example.com:443
      NETBIRD_MGMT_GRPC_API_ENDPOINT: https://vpn.example.com:443
      # OIDC
      AUTH_AUTHORITY: https://keycloak.example.com/auth/realms/Obmondo
    ingress:
      tls:
        - hosts:
            - vpn.example.com
          secretName: vpn.example.com
      hosts:
        - host: vpn.example.com
          paths:
            - path: /
              pathType: ImplementationSpecific

coturn:
  coturn:
    realm: "turn.vpn.example.com"
    auth:
      existingSecret: netbird
      secretKeys:
        username: turnServerUser
        password: turnServerPassword
